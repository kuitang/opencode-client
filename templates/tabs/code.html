{{/* Component templates defined FIRST (bottom-up) */}}
{{define "code-left-content"}}
<div id="file-selector-wrapper">
    <select id="file-selector"
            class="px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px]"
            name="path"
            hx-get="/tab/code/file"
            hx-trigger="change"
            hx-target="#code-content"
            hx-swap="innerHTML"
            onfocus="htmx.ajax('GET', '/tab/code/filelist?options_only=true&current=' + encodeURIComponent(this.value), {target: this, swap: 'innerHTML'})">
        {{if .Files}}
            <option value="">Select a file...</option>
            {{range .Files}}
            <option value="{{.Path}}">{{.Path}}</option>
            {{end}}
        {{else}}
            <option value="">No files generated</option>
        {{end}}
    </select>
</div>
{{end}}

{{define "code-buttons"}}
<button id="copy-btn"
        class="px-4 py-2 text-sm font-medium text-gray-600 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px]"
        onclick="
            const pre = document.querySelector('#code-content pre');
            if (pre) {
                const text = Array.from(pre.querySelectorAll('code')).map(c => c.textContent).join('\n');
                navigator.clipboard.writeText(text).then(() => {
                    this.innerHTML = '<svg class=\'w-4 h-4 mr-2 inline text-green-600\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M5 13l4 4L19 7\'/></svg>Copied!';
                    this.classList.add('text-green-600');
                    setTimeout(() => {
                        this.innerHTML = '<svg class=\'w-4 h-4 mr-2 inline\' fill=\'none\' stroke=\'currentColor\' viewBox=\'0 0 24 24\'><path stroke-linecap=\'round\' stroke-linejoin=\'round\' stroke-width=\'2\' d=\'M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\'/></svg>Copy';
                        this.classList.remove('text-green-600');
                    }, 2000);
                });
            }
        ">
    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
    </svg>
    Copy
</button>
<a href="/download" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 min-h-[44px] inline-flex items-center">
    <svg class="w-4 h-4 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
    </svg>
    Download
</a>
{{end}}

{{define "code-main-content"}}
<div class="bg-gray-900 text-gray-100 min-h-[600px] font-mono text-sm">
    <!-- Code Content Area -->
    <div id="code-content" class="p-6">
        <div class="text-center py-20">
            <svg class="w-16 h-16 mx-auto text-gray-500 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
            </svg>
            <h3 class="text-lg font-medium text-gray-300 mb-2">
                {{if .Files}}Select a File{{else}}No Code Generated{{end}}
            </h3>
            <p class="text-gray-500 max-w-md mx-auto">
                {{if .Files}}
                Select a file from the dropdown above to view its contents.
                {{else}}
                Start a conversation to generate code. Your generated files will appear here for review and editing.
                {{end}}
            </p>
        </div>
    </div>
</div>
{{end}}

{{/* Main template defined AFTER components (top-level) */}}
{{define "tab-code"}}
<div class="max-w-4xl mx-auto">
    {{template "mac-chrome" (dict
        "Title" "Code Editor"
        "LeftContent" (renderComponent "code-left-content" .)
        "RightContent" (renderComponent "code-buttons" .)
        "MainContent" (renderComponent "code-main-content" .))}}

    <!-- Code Stats -->
    <div class="mt-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4" id="file-count-container">
                        {{template "file-count-content" .}}
                    </div>
                </div>
            </div>

            <div class="bg-white p-4 rounded-lg border border-gray-200">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                            <svg class="w-4 h-4 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="ml-4" id="line-count-container">
                        {{template "line-count-content" .}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* CSS for line numbers using counters */
pre.code-display {
    counter-reset: line;
    padding-left: 3.5em;
    position: relative;
    background-color: rgb(17 24 39); /* gray-900 */
    color: rgb(243 244 246); /* gray-100 */
}

pre.code-display code {
    counter-increment: line;
    display: block;
    position: relative;
}

pre.code-display code::before {
    content: counter(line);
    position: absolute;
    left: -3em;
    width: 2.5em;
    text-align: right;
    color: rgb(107 114 128); /* gray-500 */
    border-right: 1px solid rgb(55 65 81); /* gray-700 */
    padding-right: 0.5em;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

/* Ensure wrapped lines don't go under line numbers */
pre.code-display code {
    white-space: pre-wrap;
    word-break: break-all;
}
</style>
{{end}}